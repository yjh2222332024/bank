# 云数据库表结构规范 (MVP v1.2)

**维护人**：组员 C（后端逻辑开发）

**协作者**：组员 D（安全规则配置）、总负责人（基础数据录入）

**状态**：已定稿（Ready for Dev）



***

## 一、 全局安全与读写约定（底线红线）



1. **绝对禁止前端直写**：任何涉及资金增减、角色绑定、状态修改的操作，**严禁**前端直接调用 `db.collection().update()`，必须且只能通过云函数执行。

2. **强制使用原子操作**：在更新 `balance` 时，必须使用聚合指令 `db.command.inc()`，彻底杜绝 "先查余额 -> 内存计算 -> 再 Update 覆盖" 的低级并发 Bug。

3. **事务强一致性 (Transaction)**：核心加减钱逻辑必须使用 `db.runTransaction`，确保 "扣发款项" 与 "生成流水" 同成功、同失败。

4. **防重复提交 (Idempotency)**：流水表必须基于 `requestId` 做唯一性校验，拦截弱网环境下的 "夺命连环点"。



***

## 二、 核心集合设计 (Collections)

### 1. 静态角色字典表 (`roles_config`) [架构优化新增]



* **功能描述**：剧本杀系统初始化配置表。存放 7 个角色的基础设定，解耦代码，方便未来无缝接入其他剧本。

* **权限配置**：`所有人可读，仅管理员可写`。

* **数据结构 (JSON Schema)**：



```
{

  "_id": "role_001",

  "roleId": "ye_shujin",               // 角色唯一标识

  "roleName": "叶舒瑾",                 // 角色真名

  "codeName": "满洲贵族",               // 抗日复古代号

  "initBalance": 80000,                // 该角色开局自带的初始大洋

  "avatarUrl": "cloud://xxx..."        // 角色精美海报/头像的云存储 CDN 链接

}
```

### 2. 游戏场次表 (`game_sessions`) [防串车必备]



* **功能描述**：用于 DM 管理房间生命周期，将不同时间、不同房间的对局数据严格物理隔离。

* **权限配置**：所有人可读，仅云函数可写。

* **索引建议**：对 `dmOpenId` 建立普通索引，方便 DM 查看历史带本记录。

* **数据结构 (JSON Schema)**：



```
{

  "_id": "session_1716384000",         // 场次唯一 ID (建议格式: session_时间戳_随机码)

  "dmOpenId": "oX99_sdf88...",         // 控场 DM 的微信 OpenID

  "status": "ACTIVE",                  // 场次状态：ACTIVE(进行中), FINISHED(已结案清档)

  "createdAt": 1716384000000,          // 开城时间

  "finishedAt": null                   // 结案时间

}
```

### 3. 玩家对局表 (`players`)



* **功能描述**：记录当前场次全场玩家的实时资产看板数据。前端通过 watch 监听此表实现 0 延迟动效。

* **权限配置**：所有人可读，仅云函数可写。

* **索引建议**：


  * 复合索引：`gameSessionId + openId` (用于玩家断线重连快速查自身数据)

  * 复合索引：`gameSessionId + roleId` (用于选角时防并发抢夺同一个角色)

* **数据结构 (JSON Schema)**：



```
{

  "_id": "xt_9982736152",

  "gameSessionId": "session_1716384000", // [防串车] 绑定的场次 ID

  "openId": "oX99_sdf88...",             // 玩家真实微信 OpenID

  "roleId": "ye_shujin",                 // 绑定的角色 ID

  "roleName": "叶舒瑾",                   // 冗余字典表字段，减少联表查询

  "codeName": "满洲贵族",

  "balance": 80000,                      // [核心] 当前大洋余额 (Number 类型)

  "isDM": false,                         // 是否拥有该场次的管理员权限

  "createdAt": 1716384000000,

  "updatedAt": 1716384000000             // 余额最后一次变动的时间戳，用于触发动效判断

}
```

### 4. 交易流水凭证表 (`transactions`)



* **功能描述**：金融级对账表。记录游戏内每一笔大洋的流转方向与余额快照。

* **权限配置**：所有人不可读写（极度机密，前端必须通过 `get_ledger_logs` 云函数分页拉取）。

* **索引建议**：


  * 唯一索引 (Unique)：`requestId` (利用数据库级唯一约束，硬核防弱网连点超发)

  * 复合索引：`gameSessionId + timestamp` (降序排列，用于拉取房间流水)

* **数据结构 (JSON Schema)**：



```
{

  "_id": "tx_554829102",

  "gameSessionId": "session_1716384000", // 所属场次 ID

  "requestId": "uuid-88392-xx",          // [防连点] 前端发起的 UUID 请求凭据

  "senderOpenId": "SYSTEM_DM",           // 付款方 ("SYSTEM_DM" 代表 DM 分发或系统扣除)

  "receiverOpenId": "oX99_sdf..",        // 收款方 OpenID

  "amount": 5000,                        // 变动金额 (Number绝对值，杜绝负数)

  "balanceAfter": 85000,                 // [易对账] 该笔交易成功后，收款方的最新结余

  "tradeType": "ADD",                    // 交易枚举：ADD(系统增加), SUBTRACT(系统扣除), TRANSFER(玩家私交)

  "source": "情报交易分成",                // 资金来源事由（展示给玩家看的文案）

  "timestamp": 1716384000000             // 13位毫秒级时间戳

}
```

> （注：文档部分内容可能由 AI 生成）