# QA 安全测试与压测用例 (MVP v1.2)

**维护人**：组员 D（安全与 QA 开发） 
**协同测试**：组员 C（后端配合排查日志）、组员 B（前端配合弱网模拟）
**状态**：已定稿（Ready for QA）

---

## 一、 越权与防作弊测试 (权限校验逻辑审计)

剧本杀场景下，玩家的信任感极度依赖系统的公平性。必须杜绝任何利用抓包工具或控制台篡改资金的作弊行为。

* **用例 1.1：普通玩家强调 DM 接口（垂直越权拦截）**
  * **测试场景**：使用非 DM（普通玩家）的微信登录态，强行伪造请求体调用 `execute_transaction` 或 `end_game_session` 云函数，尝试给自己加钱或强行结束游戏。
  * **预期结果**：后端必须严格校验 `players` 表中该 `OPENID` 的 `isDM` 字段。请求必须被拦截，并返回 `code: 401` 或无权限错误提示。
* **用例 1.2：伪造身份查账/转账（水平越权拦截）**
  * **测试场景**：在调用 `get_player_info` 或 `transfer_money` 接口时，在参数中强行传入其他玩家的 `roleId` 或 `openId`。
  * **预期结果**：后端必须忽略前端传入的任何操作者身份参数，强制提取当前微信运行环境的 `cloud.getWXContext().OPENID` 作为唯一凭证。篡改无效。
* **用例 1.3：前端直连数据库提权（云数据库权限规则测试）**
  * **测试场景**：在小程序开发者工具的控制台中，绕过云函数，直接调用 `db.collection('players').doc('xxx').update({ data: { balance: 9999999 } })` 尝试修改余额。
  * **预期结果**：微信云开发直接报错 `Permission Denied`。验证组员 D 是否正确配置了数据库的安全规则（players 表仅限只读或不可读写）。

---

## 二、 并发、幂等与防超卖测试 (金融级压力测试)

由于线下带本经常遇到“暗室手抖连点”或“信号差转圈圈”，这部分测试是 MVP 稳健运行的生死线。

* **用例 2.1：高频连点防超发（并发加钱与 inc 指令校验）**
  * **测试场景**：编写自动化脚本，模拟 DM 在 1 秒内连续发起 10 次“给玩家加 1000 大洋”的请求（每次请求携带**不同**的 `requestId`）。
  * **预期结果**：该玩家余额必须**精确**增加 10000，且 `transactions` 表中生成不多不少正好 10 条记录。验证后端是否有效使用了 `db.command.inc()` 聚合指令，严禁出现并发查写导致的金额覆写。
* **用例 2.2：弱网环境幂等性（防重复提交/唯一索引测试）[高危必测]**
  * **测试场景**：模拟网络极差环境。DM 点击一次“发放 2000 大洋”，由于没收到响应又狂点 4 次重试按钮。前端携带**同一个** `requestId` 发起了 5 次请求。
  * **预期结果**：玩家余额**只能且必须只增加 2000**，流水表仅生成 1 条记录。验证数据库流水表的 `requestId` 唯一索引（Unique Index）是否生效，拦截了“幽灵重试”。
* **用例 2.3：余额不足极限扣款（防负数穿透）**
  * **测试场景**：某玩家余额仅剩 5000 大洋。利用脚本瞬间并发发起两笔“扣除 5000 大洋”的请求。
  * **预期结果**：仅第一笔扣款成功，第二笔必须被 Transaction 事务拦截并返回 `code: 403 (余额不足)`。玩家最终余额必须为 0，绝对不允许出现负数（-5000）。
* **用例 2.4：开局并发抢角测试（防多绑一）[新增]**
  * **测试场景**：游戏开局，玩家 A 和玩家 B 手机同时扫码，并在同一毫秒点击绑定“满洲贵族 - 叶舒瑾”。
  * **预期结果**：有且仅有一名玩家绑定成功并获得初始资金 80000。另一名玩家弹出提示 `code: 403 (该角色已被抢占)`，需重新选角。

---

## 三、 场次隔离与一致性测试 (多车同开防串车)

* **用例 3.1：跨场次转账拦截**
  * **测试场景**：玩家保留了上周打本的 `gameSessionId` 小程序码，扫码进入后，尝试调用 `transfer_money` 将 10000 大洋转给当前正在打本的朋友。
  * **预期结果**：后端校验该 `gameSessionId` 的状态。如果是 `FINISHED`，直接拦截；若为另一个进行中的场次，校验该玩家的 `OPENID` 是否在目标场次的 `players` 表中。最终判定拦截，返回异常提示。
* **用例 3.2：批量分发异常与事务回滚**
  * **测试场景**：DM 使用“一键分发逻辑”向全场 7 名玩家发钱。测试时人为模拟代码异常（如使第 7 名玩家的入库操作失败）。
  * **预期结果**：必须触发 `db.runTransaction` 的完整回滚。前 6 名玩家的余额均不增加，不产生任何流水记录。彻底杜绝“部分成功、部分失败”的脏数据。

---

## 四、 线下实景极端容错测试 (UI/UX 与环境适应)

* **用例 4.1：暗室环境与盲操测试**
  * **测试场景**：QA 调低手机屏幕亮度，在黑暗环境中快速滑动 DM 控制台“拨盘面板”，并尝试点击非按钮边缘区域。
  * **验收标准**：
    1. 核心操作区（加/减大洋按钮）的触控热区必须足够大（最小 44x44 pt）。
    2. “扣除/罚款”操作如果导致玩家破产（余额清零），必须有高对比度、带明显触觉反馈（振动 `wx.vibrateShort()`）的二次确认弹窗防误触。
* **用例 4.2：动效性能与防卡死测试**
  * **测试场景**：在安卓千元低端机上，玩家 10 秒内连续收到 5 笔不同来源的转账/系统发钱。
  * **验收标准**：前端的 `watch` 监听器不能崩溃。Lottie 印章动效需做队列防抖排期或平滑重置，不能出现动画卡死、黑屏或数字滚盘重影。