# 游戏生命周期管理 SOP (MVP v1.2)

**维护人**：总负责人 (PM)
**适用对象**：全体研发成员、QA、未来实地控场的 DM
**文档目标**：将线下物理空间的剧本杀进程，精准映射为线上系统的 API 调用与状态流转。

---

## 🧭 全局状态机概述 (State Machine)

一场《谍影钱庄》的对局，其 `game_sessions` 表的状态将经历以下单向流转：
`[无状态]` -> **创建 (ACTIVE)** -> **机制博弈 (ACTIVE)** -> **结案封版 (FINISHED)**

---

## 🎬 阶段一：DM 开城建档 (游戏准备期)

**【线下场景】** 玩家陆续到达房间，DM 正在整理剧本和线索卡。
**【系统流转】**
1. **DM 登录**：DM 扫专属管理员码，进入【DM 控台】界面。
2. **初始化场次**：DM 点击“新建场次”，前端调用 `create_game_session` 接口。
3. **生成入口**：后端生成全局唯一的 `gameSessionId`（状态设为 `ACTIVE`），前端将其转化为一个带有参数的小程序码（或房间二维码）。
4. **物理投屏**：DM 将该二维码投屏在电视上，或打印放在桌签上。

---

## 🕵️ 阶段二：玩家入座选角 (绑定与发钱)

**【线下场景】** 玩家阅读完剧本第一幕，明确了自己的身份代号（如：“我是满洲贵族”）。
**【系统流转】**
1. **扫码入场**：7 名玩家同时扫描桌上的二维码，前端携带 `gameSessionId` 调用 `get_session_status`。
2. **渲染选角页**：前端根据后端返回的 `availableRoles`（未被占用的角色），渲染出 7 张带有浓厚民国特工风的角色海报。
3. **并发抢角**：
   - 玩家点击自己对应的海报，调用 `bind_role`。
   - **[防串车防线]** 后端开启事务校验，确保该角色未被他人绑定。
   - 绑定成功后，系统按字典表 `roles_config` 自动下发初始资金（如 80000 大洋）。
4. **长连接建立**：绑定成功后，前端立刻触发 `wx.cloud.database().watch()`，该玩家正式接入实时大洋监听网络。

---

## 💰 阶段三：机制博弈 (高频资金流转)

**【线下场景】** 游戏进入高潮，玩家需要购买线索、私下买卖情报，DM 需要发放阵营补贴。
**【系统流转】**

### 场景 A：玩家间私下交易 (黑市情报买卖)
1. 玩家 A（买家）在自己手机上点击【发起交易】，选择目标角色【记者 - 戈智也】。
2. 输入金额（如 5000 大洋），调用 `transfer_money` 接口（携带 UUID 作为 `requestId` 防连点）。
3. 后端事务处理成功后，watch 机制瞬间触发。玩家 B 的手机屏幕数字实时跳变，配合基础的 CSS 颜色渐变（如入账闪烁军绿色，扣款闪烁警告红），确保资金变动的即时感知。

### 场景 B：DM 宏观调控 (搜证位购买/罚款)
1. 玩家请求购买线索卡，DM 掏出手机，在【DM 控台】选择该玩家。
2. 转动复古拨盘（滑动选择 -2000 大洋），点击确认，调用 `execute_transaction`。
3. 玩家手机屏幕瞬间弹出红色扣款印章动效，大洋减少，DM 将实体线索卡递给玩家。

---

## 🔒 阶段四：复盘结案 (封版清档)

**【线下场景】** 凶手被投出，DM 开始复盘故事线，准备结账让玩家离场。
**【系统流转】**
1. **一键结案**：DM 在控制台点击【结束本局】并进行高亮二次确认，调用 `end_game_session`。
2. **状态锁定**：后端将该 `gameSessionId` 的状态更改为 `FINISHED`。
3. **玩家端冻结**：
   - 前端监听到场次状态变为 `FINISHED`，立刻自动跳转至“剧本杀结束 - 财务对账单”页面。
   - 所有“转账”、“加减钱”按钮全部置灰隐藏。
   - 玩家仅能向下滚动查看复古报纸样式的流水账单（调用 `get_ledger_logs`），截屏发朋友圈装 X。
4. **彻底散场**：系统对该房间闭环，即使玩家明天再扫这个码，也只能看到结案页面，无法再进行任何操作。

---

## 🚑 附录：异常场景应急处理 SOP (Exception Handling)

为了保证线下剧本杀不因系统 Bug 停滞，特制定以下预案：

1. **玩家手机没电 / 意外杀后台关机**：
   - **处理方案**：玩家充好电或换借手机后，**重新扫描**桌上的场次二维码。系统识别其微信 `OPENID`，会自动跳过选角页，直接渲染最新的大洋余额。不丢失任何数据。
2. **玩家瞎选，选错了别人的角色**：
   - **处理方案**：MVP 阶段暂不开发复杂的“解绑功能”。若发生此类事故，DM 需在控台点击【强制废弃本局】，系统将状态置为 `FINISHED`，DM 重新新建场次（生成新码）让全员重新扫码选角（耗时 < 1分钟）。
3. **没网了，死活连不上**：
   - **处理方案**：前端需做极致的 Loading 兜底。若长达 10 秒无响应，弹出“军统电报塔受损，请连接店长 WiFi 或交给 DM 手动记账”。决不能让系统卡死导致玩家干瞪眼。